# Vercel + MongoDB 开发 EasyExp 简易账本 核心开发思路（最终版）

你补充了 Excel 导出、自定义类型/支付方式配置及用户验证需求，我已整合所有功能，形成包含数据安全校验的完整落地框架，确保数据不被随意修改：

---

## 一、数据模型升级（MongoDB）

新增「用户集合」「系统配置集合」，完善支出记录集合，通过用户关联实现数据权限管控：

### 1. 用户集合（user）

存储用户验证信息，支撑身份校验与数据隔离：

```JavaScript

{
  username: String,        // 用户名（唯一标识）
  password: String,        // 加密存储的密码（如 bcrypt 哈希后）
  email: String,           // 可选，用于找回密码
  createTime: { type: Date, default: Date.now },
  updateTime: Date
}
```

### 2. 系统配置集合（config）

新增用户关联字段，确保配置仅归属对应用户，避免跨用户篡改：

```JavaScript

{
  userId: String,          // 关联用户集合 _id，实现配置数据隔离
  type: String,            // 配置类型：reimburseType（报销类型）/payType（支付类型）
  options: [String],       // 可选值列表，如 ["微信", "支付宝", "网银"]
  updateTime: Date         // 最后更新时间
}
```

### 3. 支出记录集合（expense）

新增用户关联字段，绑定数据归属，实现仅本人可操作：

```JavaScript

{
  userId: String,          // 关联用户集合 _id，标记数据归属
  amount: Number,          // 支出金额（必填）
  reimburseType: String,   // 报销类型（关联当前用户 config 中 reimburseType 的 options）
  reimburseAmount: Number, // 实际报销金额（仅 reimburseType 为「已报销」时必填）
  payType: String,         // 支付类型（关联当前用户 config 中 payType 的 options）
  date: Date,              // 支出日期
  other: String,           // 其他备注信息
  createTime: { type: Date, default: Date.now }
}
```

---

## 二、核心功能开发逻辑（新增用户验证）

### 1. 用户验证核心流程

- 身份认证方式：采用 JWT（JSON Web Token）实现无状态验证，适配 Vercel Serverless 环境；

- 登录逻辑：用户提交用户名/密码，后端校验通过后生成 JWT 令牌（含 userId），返回给前端存储（localStorage）；

- 权限拦截：所有操作数据的 API 接口（支出 CRUD、配置修改、Excel 导出），均需验证请求头中的 JWT 令牌，解析 userId 后仅查询/操作该用户的数据；

- 登出逻辑：前端清除存储的 JWT 令牌，后端无需额外处理（JWT 自带过期时间，可配置短期有效，增强安全性）。

### 2. 新增支出弹窗（适配用户验证与自定义配置）

- 权限前置：弹窗仅登录用户可触发，未登录时点击「新增支出」跳转至登录页；

- 数据联动：登录后调用 `/api/config` 时，自动携带 JWT 令牌，后端返回当前用户的报销类型、支付类型列表，渲染下拉选项；

- 表单校验与提交：保持原有逻辑，提交时后端自动将解析出的 userId 写入支出记录，确保数据归属正确。

### 3. 统计页面（新增筛选条件）

- 数据隔离：统计时仅聚合当前登录用户（userId 匹配）的支出记录，筛选条件均基于本人数据生效，避免跨用户数据混淆；

- 新增筛选条件：支持多维度组合筛选，筛选后统计结果实时联动更新，核心筛选项包括：
   日期筛选：按时间段筛选（今日、本周、本月、上月、自定义日期范围），适配日期控件选择逻辑；

- 报销类型筛选：下拉选择（关联当前用户自定义的报销类型列表，支持「全部」选项）；

- 支付类型筛选：下拉选择（关联当前用户自定义的支付类型列表，支持「全部」选项）；

- 筛选交互：筛选控件集中布局在统计区域顶部，添加「重置筛选」按钮，一键恢复默认（全部数据统计）。

统计逻辑：筛选后按规则计算——支出总额（筛选后所有记录 amount 求和）、待报销金额（筛选后 reimburseType 为「待报销」的 amount 求和）、报销中金额（筛选后 reimburseType 为「报销中」的 amount 求和）、已报销金额（筛选后 reimburseType 为「已报销」的 reimburseAmount 求和）、收支差额（筛选后支出总额 - 筛选后已报销金额）。

联动适配：筛选条件与支出列表筛选保持一致，切换筛选时列表数据与统计结果同步更新，提升用户操作连贯性。

- 数据隔离：统计时仅聚合当前登录用户（userId 匹配）的支出记录，避免跨用户数据混淆；

- 逻辑不变：支出总额、待报销/报销中金额（取 amount）、已报销金额（取 reimburseAmount）、收支差额（支出总额-已报销金额）。

### 4. 支出列表（含 Excel 导出与权限控制）

- 列表渲染：仅展示当前用户的支出记录，一行一条数据，展示日期、金额、报销类型、支付类型、报销金额、操作（编辑/删除）；

- Excel 导出功能：仅导出当前用户的筛选后记录，未登录用户无法触发导出按钮，后端校验令牌确保仅导出本人数据；

- 操作权限：编辑/删除按钮仅对当前用户的记录生效，后端二次校验数据归属，防止通过接口恶意修改他人数据。

### 5. 设置弹窗（自定义类型/支付方式）

- 权限控制：未登录用户无法打开设置弹窗，后端更新配置时，仅修改当前用户（userId 匹配）的 config 数据；

- 功能模块：保持原有添加/删除逻辑，删除类型前校验当前用户的支出记录是否引用该类型，避免数据异常；

- 提交与联动：保存后刷新当前用户的下拉选项，不影响其他用户配置。

### 6. API 接口补充（新增用户验证相关）

|接口路径|方法|功能说明|
|---|---|---|
|`/api/auth/login`|POST|用户登录，校验信息后返回 JWT 令牌|
|`/api/auth/logout`|POST|前端清除令牌，后端无业务逻辑（可选接口）|
|`/api/config`|GET|获取当前用户的报销类型、支付类型配置列表（需验证 JWT）|
|`/api/config`|PUT|更新当前用户的配置（需验证 JWT）|
|`/api/expenses/export`|GET|导出当前用户的支出记录（需验证 JWT）|
|原有支出 CRUD 接口|-|均添加 JWT 验证，仅操作当前用户数据|
---

## 三、关键注意事项

1. **用户验证安全**：密码需通过 bcrypt 等算法加密存储，禁止明文保存；JWT 令牌设置合理过期时间（如 24 小时），可添加刷新令牌机制优化体验；请求头携带令牌时，避免使用 URL 参数传递，防止泄露。

2. **自定义类型的校验**：删除类型时必须校验当前用户的支出记录是否引用该类型，避免数据异常；同时校验 JWT 确保仅本人操作。

3. **Excel 导出兼容性**：使用 `xlsx` 库处理数据格式，确保日期、数字字段正常显示，仅导出当前用户筛选后的数据，防止信息泄露，导出文件名可携带筛选时间段（如「2026年1月支出记录.xlsx」）提升辨识度。

4. **配置缓存与权限同步**：前端缓存配置数据时，需关联用户身份，切换用户登录后清空旧缓存；未登录用户拦截所有数据操作接口及筛选功能，跳转至登录页。

5. **数据安全兜底**：所有 API 接口均需双重校验（JWT 验证 + 数据归属校验），即使令牌泄露，也无法操作他人数据；配置更新接口需防空值、防重复值，支出记录需校验金额为正数等基础规则。

6. **筛选逻辑一致性**：统计页面与支出列表共用一套筛选参数，确保筛选后的数据统一，避免出现统计结果与列表数据不匹配的情况；日期筛选需处理跨月、跨年场景，确保时间范围计算准确。

---

### 总结

1. 新增用户集合与 JWT 验证机制，通过 userId 关联所有数据，实现数据隔离与权限管控，防止随意修改他人数据；

2. 所有核心功能（新增支出、配置管理、统计、导出）均添加权限前置校验，未登录用户仅可访问登录页，确保数据安全；

3. API 接口统一增加 JWT 验证与数据归属校验，双重保障数据不被恶意篡改，同时保持原有业务逻辑与用户体验；

4. 自定义类型、Excel 导出等功能与用户验证深度适配，既满足个性化需求，又兼顾数据安全性；

5. 统计页面新增多维度筛选条件，与支出列表筛选联动，支持日期、报销类型、支付类型组合筛选，提升数据统计的灵活性与实用性，同时保障筛选逻辑与数据一致性。


> （注：文档部分内容可能由 AI 生成）